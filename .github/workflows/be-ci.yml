name: BE CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "**/*.java"
      - "**/*.kt"
      - "**/*.gradle"
      - "**/*.gradle.kts"
      - "gradle/**"
      - "gradlew"
      - "gradlew.bat"
      - ".github/workflows/**"
      - "**/*.yml"
      - "**/*.yaml"
  push:
    branches: [ "main" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
  
permissions:
  contents: read
  security-events: write

jobs:
  be-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        java-version: [ "21" ] 

    steps:
      # Step 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # Step 1.1) Trivy Secret Scan (Fail-fast)
      - name: Trivy Secret Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "secret"
          format: "table"
          exit-code: "1"

      # Step 1.2) CodeQL Init (SAST 준비)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java

      # Step 2) Setup Java (JDK)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ matrix.java-version }}
          cache: "gradle"

      # Step 3) Gradle Wrapper 권한/환경 확인
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Step 4) Cache (Gradle)
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: "${{ runner.os }}-java${{ matrix.java-version }}-gradle-${{ hashFiles('**/*.gradle*', '**/settings.gradle*', '**/gradle-wrapper.properties', '**/gradle.properties') }}"

      # [추가] OWASP Dependency Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'BE-Project'
          path: '.'
          format: 'HTML'
          out: 'reports'
      # 의존성 해결후에 확인하는 것이 좋음
      # 너무 무거우면 trivy에 아래 내용으로 추가, 변경
      #    scanners: "vuln"      # secret 대신 vuln(취약점) 사용
      #    severity: "CRITICAL,HIGH" # 심각한 취약점만 검출 (필요 시 MEDIUM 추가)

      # Step 5) Build (Gradle)
      - name: Build
        run: ./gradlew --no-daemon clean build

      # Step 6) Formatting check (Spotless)
      - name: Spotless Check
        run: ./gradlew --no-daemon spotlessCheck

      # Step 7) Tests + JaCoCo Report 생성
      # JUnit5, Mockito, REST Assured 
      - name: Tests & JaCoCo Coverage
        run: ./gradlew --no-daemon test jacocoTestReport

      # Step 7.5) CodeQL Analyze (SAST 실행/업로드)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

      # Step 8) Upload test artifacts
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: be-artifacts-java${{ matrix.java-version }}
          path: |
            build/test-results/test/
            build/reports/tests/test/
            build/reports/jacoco/test/html/  # JaCoCo HTML 리포트 경로 명시
            build/libs/*.jar
            reports/dependency-check-report.html
          retention-days: 1
