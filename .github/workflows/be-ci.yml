name: BE CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "**/*.java"
      - "**/*.kt"
      - "**/*.gradle"
      - "**/*.gradle.kts"
      - "gradle/**"
      - "gradlew"
      - "gradlew.bat"
      - ".github/workflows/**"
      - "**/*.yml"
      - "**/*.yaml"
    branches: [ "main", "cd/be-cd2" ]
  push:
    branches: [ "dev", "cd/be-cd2" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  be-ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        java-version: [ "21" ]

    steps:
      # Step 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # Step 1.1) Trivy Secret Scan (Fail-fast)
      - name: Trivy Secret Scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "vuln"
          format: "table"
          exit-code: "1"

      # Step 1.2) CodeQL Init (SAST 준비)
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java

      # Step 2) Setup Java (JDK)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ matrix.java-version }}
          cache: "gradle"

      # Step 3) Gradle Wrapper 권한/환경 확인
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Step 4) Formatting Check (spotless)
      - name: Check formatting
        run: ./gradlew spotlessCheck --no-daemon

      # [추가] OWASP Dependency Check
      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: "BE-Project"
          path: '.'
          format: "HTML"
          args: >-
            --failOnCVSS 7

      # Step 5) Build (Gradle)
      - name: Build
        run: ./gradlew --no-daemon clean build

      # Step 6) Tests + JaCoCo Report 생성
      - name: Tests & JaCoCo Coverage
        run: ./gradlew --no-daemon test jacocoTestReport

      # Step 7) CodeQL Analyze (SAST 실행/업로드)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java"

      # Step 8) Upload test artifacts
      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: be-artifacts-java${{ matrix.java-version }}
          path: |
            build/test-results/test/
            build/reports/tests/test/
            build/reports/jacoco/test/html/
          retention-days: 1
