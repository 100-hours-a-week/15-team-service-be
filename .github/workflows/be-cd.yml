name: Backend CD Pipeline (Big Bang)

# 1. 트리거: 'Backend CI Pipeline' 워크플로우가 'main' 브랜치에서 '완료'되었을 때 실행
on:
  push: 
      branches: [ "main", "ci/be-ci5" ]
  workflow_dispatch:

concurrency:
  group: cd-myapi-main
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        java-version: [ "21" ] 

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ matrix.java-version }}
          cache: "gradle"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build
        run: ./gradlew --no-daemon clean build

      # 2) EC2로 JAR 파일 전송 (SCP)
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@v0.1.7 # 특정 버전 사용
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SECRET_KEY }}
          port: ${{ secrets.PORT }}
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.DEPLOY_USER }}/temp_deploy/build/libs/"
          strip_components: 1

      # 3) 서버 접속 및 배포 스크립트 실행
      - name: Execute Big Bang Deployment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SECRET_KEY }}
          port: ${{ secrets.PORT }}
          script_stop: true
          
          script: |
            # 1. 변수 설정
            APP_ROOT="${{ var.APP_ROOT }}/app"
            TEMP_DIR="${{ var.APP_ROOT }}/temp_deploy"
            BACKUP_DIR="${{ var.APP_ROOT }}/backup"
            SERVICE_NAME="${{ secrets.SERVICE_NAME }}"
            JAR_NAME="${{ secrets.JAR_NAME }}"
            HEALTH_URL="http://localhost:8080/actuator/health"
            HEALTH_TIMEOUT="60"
            HEALTH_INTERVAL="5"

            echo "[Deploy] 배포 시작..."

            # 2. 디렉토리 생성
            mkdir -p $APP_ROOT
            mkdir -p $TEMP_DIR
            mkdir -p $BACKUP_DIR

            # 3. 서비스 중지
            echo "[2/6] 서비스 종료 중..."
            sudo systemctl stop $SERVICE_NAME || true

            # 4. 백업
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            if [ -f "$APP_ROOT/$JAR_NAME" ]; then
                mv $APP_ROOT/$JAR_NAME $BACKUP_DIR/server_$TIMESTAMP.jar
                echo "[3/6] 백업 완료"
            fi

            # 5. 새 파일 교체
            echo "[4/6] 새 파일 찾는 중..."
            
            # [핵심 로직]
            # 1. find $TEMP_DIR: 하위 폴더까지 싹 뒤짐
            # 2. ! -name '*-plain.jar': 이름에 'plain'이 들어간 건 껍데기니 제외함
            # 3. head -n 1: 그 중 하나만 선택
            FOUND_JAR=$(find $TEMP_DIR -name '*.jar' ! -name '*-plain.jar' | head -n 1)

            if [ -n "$FOUND_JAR" ]; then
                echo "파일 발견: $FOUND_JAR"
                mv "$FOUND_JAR" "$APP_ROOT/$JAR_NAME"
                chmod +x "$APP_ROOT/$JAR_NAME"
                echo "파일 교체 및 권한 부여 완료"
            else
                echo "오류: $TEMP_DIR 안에 실행 가능한 JAR 파일이 없습니다!"
                echo "폴더 구조 확인:"
                ls -R $TEMP_DIR
                
                # 롤백 시도
                if [ -f "$BACKUP_DIR/server_$TIMESTAMP.jar" ]; then
                    mv $BACKUP_DIR/server_$TIMESTAMP.jar $APP_ROOT/$JAR_NAME
                    sudo systemctl start $SERVICE_NAME
                fi
                exit 1
            fi

            # 5.5) SSM -> .yml 생성
            echo "[5/6-Env] SSM Parameter Store -> .yml 생성..."
            sudo /usr/local/bin/render-yml.sh

            # 6. 서비스 시작
            echo "[5/6] 서비스 시작..."
            sudo systemctl start $SERVICE_NAME

            # 7. Health Check
            echo "[6/6] Health Check..."
            elapsed=0
            while [ $elapsed -lt $HEALTH_TIMEOUT ]; do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
              if [ "$STATUS" = "200" ]; then
                echo "배포 성공!"
                # 임시 폴더 비우기
                rm -rf $TEMP_DIR/*
                exit 0
              fi
              sleep $HEALTH_INTERVAL
              elapsed=$((elapsed + HEALTH_INTERVAL))
            done
            
            echo "Health Check 실패. 롤백을 시도합니다."
            
            # 롤백 로직
            sudo systemctl stop $SERVICE_NAME
            mv $APP_ROOT/$JAR_NAME $APP_ROOT/$JAR_NAME.failed_$TIMESTAMP
            
            if [ -f "$BACKUP_DIR/server_$TIMESTAMP.jar" ]; then
                mv $BACKUP_DIR/server_$TIMESTAMP.jar $APP_ROOT/$JAR_NAME
                sudo systemctl start $SERVICE_NAME
                echo "롤백 완료."
            fi
            exit 1