name: Backend CD Pipeline (Big Bang)

# 1. 트리거: 'Backend CI Pipeline' 워크플로우가 'main' 브랜치에서 '완료'되었을 때 실행
on:
  push:              # [임시 추가] CD 파일 수정해서 올리면 바로 실행되게 함
      branches: [ "ci/be-ci" ]
  workflow_dispatch:
  workflow_run:
    workflows: ["BE CI"] # ci.yml의 'name' 값과 정확히 일치
    types:
      - completed
    branches: ["main", "ci/be-ci"]

concurrency:
  group: cd-myapi-main
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    # CI가 '성공'했을 때만 CD 실행
    # if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1) CI 워크플로우에서 생성된 Artifact(JAR) 다운로드
      # (서로 다른 워크플로우 간 파일 공유를 위해 서드파티 액션 사용 권장)
      - name: Download Artifact from CI
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: be-ci.yml # ci.yml 파일명 또는 name
          run_id: ${{ github.event.workflow_run.id }}
          name: be-artifacts-java21 # CI에서 업로드한 아티팩트 이름
          path: deploy/

      # 디버깅용: 파일이 어디 있는지 전체 출력
      - name: Check File Path
        run: ls -R deploy/

      # 2) EC2로 JAR 파일 전송 (SCP)
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@v0.1.7 # 특정 버전 사용
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SECRET_KEY }}
          port: ${{ secrets.PORT }}
          source: "deploy/*.jar"
          target: "/home/${{ secrets.DEPLOY_USER }}/temp_deploy/"
          strip_components: 1

      # 3) 서버 접속 및 빅뱅 배포 스크립트 실행 (SSH)
      - name: Execute Big Bang Deployment
        uses: appleboy/ssh-action@master
        env:
          APP_ROOT: ${{ secrets.APP_ROOT }}
          TEMP_DIR: ${{ secrets.TEMP_DIR }}
          BACKUP_DIR: ${{ secrets.BACKUP_DIR }}
          SERVICE_NAME: ${{ secrets.SERVICE_NAME }} # systemd 서비스 이름
          JAR_NAME: ${{ secrets.JAR_NAME }}

        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.SECRET_KEY }}
          port: ${{ secrets.PORT }}
          script_stop: true
          
          envs: APP_ROOT, TEMP_DIR, SERVICE_NAME, JAR_NAME
          
          script: |
            echo "[Deploy] Big Bang 배포 시작..."

            # 사전 준비: 디렉토리 생성
            mkdir -p $APP_ROOT
            mkdir -p $TEMP_DIR
            mkdir -p $BACKUP_DIR

            # 1. 서비스 중단 (Stop) - 실패해도 계속 진행하도록 || true 추가
            echo "[2/6] 서비스 종료 중..."
            sudo systemctl stop $SERVICE_NAME || true

            # 2. 기존 파일 백업
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            if [ -f "$APP_ROOT/$JAR_NAME" ]; then
                mv $APP_ROOT/$JAR_NAME $BACKUP_DIR/server_$TIMESTAMP.jar
                echo "[3/6] 백업 완료: server_$TIMESTAMP.jar"
            else
                echo "[3/6] 기존 파일 없음 (백업 생략)"
            fi

            # 3. 새 파일 교체
            # find 명령어로 jar 파일 유무를 확실하게 체크
            if [ -n "$(find $TEMP_DIR -maxdepth 1 -name '*.jar' -print -quit)" ]; then
                mv $TEMP_DIR/*.jar $APP_ROOT/$JAR_NAME
                chmod +x $APP_ROOT/$JAR_NAME
                echo "[4/6] 파일 교체 완료"
            else
                echo "[4/6] 오류: 배포할 JAR 파일을 찾을 수 없습니다."
                # 롤백 시도 (기존 백업이 있다면)
                if [ -f "$BACKUP_DIR/server_$TIMESTAMP.jar" ]; then
                    mv $BACKUP_DIR/server_$TIMESTAMP.jar $APP_ROOT/$JAR_NAME
                    sudo systemctl start $SERVICE_NAME
                fi
                exit 1
            fi

            # 5. 서비스 재시작 (Start)
            echo "[5/6] 서비스 시작..."
            sudo systemctl start $SERVICE_NAME

            # 6. Health Check (Spring Boot Actuator 경로 확인 필요)
            echo "[6/6] Health Check 진행 중..."
            elapsed=0
            # 성공(200 OK)할 때까지 루프, 타임아웃 시 실패 처리
            until [ "$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")" = "200" ]; do
              if [ "$elapsed" -ge "$HEALTH_TIMEOUT" ]; then
                echo "Health check failed after ${HEALTH_TIMEOUT}s"
                echo "롤백 프로세스 가동..."
                
                sudo systemctl stop "$SERVICE_NAME"
                # 실패한 파일 격리
                mv "$APP_ROOT/$JAR_NAME" "$APP_ROOT/$JAR_NAME.failed_$TIMESTAMP"
                
                # 백업 복구
                if [ -f "$BACKUP_DIR/server_$TIMESTAMP.jar" ]; then
                    mv "$BACKUP_DIR/server_$TIMESTAMP.jar" "$APP_ROOT/$JAR_NAME"
                    sudo systemctl start "$SERVICE_NAME"
                    echo "이전 버전 복구 완료"
                else
                    echo "복구할 백업 파일 없음"
                fi
                exit 1
              fi
              
              echo "대기 중... (${elapsed}s / ${HEALTH_TIMEOUT}s)"
              sleep "$HEALTH_INTERVAL"
              elapsed=$((elapsed + HEALTH_INTERVAL))
            done

            echo "[6/6] 배포 성공! (Health Check: 200 OK)"
            rm -rf "$TEMP_DIR"/*.jar
